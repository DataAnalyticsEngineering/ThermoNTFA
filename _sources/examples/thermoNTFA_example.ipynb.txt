{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "713e7fa1",
   "metadata": {},
   "source": [
    "# Example usage of the thermo-mechanical NTFA\n",
    "\n",
    "Felix Fritzen <fritzen@simtech.uni-stuttgart.de>,\n",
    "Julius Herb <julius.herb@mib.uni-stuttgart.de>,\n",
    "Shadi Sharba <shadi.sharba@isc.fraunhofer.de>\n",
    "\n",
    "University of Stuttgart, Institute of Applied Mechanics, Chair for Data Analytics in Engineering\n",
    "\n",
    "> **Funding acknowledgment**\n",
    "> The IGF-Project no.: 21.079 N / DVS-No.: 06.3341 of the\n",
    "> “Forschungsvereinigung Schweißen und verwandte Verfahren e.V.” of the\n",
    "> German Welding Society (DVS), Aachener Str. 172, 40223 Düsseldorf, Germany,\n",
    "> was funded by the Federal Ministry for Economic Affairs and Climate Action (BMWK)\n",
    "> via the German Federation of Industrial Research Associations (AiF) in accordance\n",
    "> with the policy to support the Industrial Collective Research (IGF)\n",
    "> on the orders of the German Bundestag.\n",
    ">\n",
    "> Felix Fritzen is funded by the German Research Foundation (DFG) --\n",
    "> 390740016 (EXC-2075); 406068690 (FR2702/8-1); 517847245 (FR2702/10-1).\n",
    "\n",
    "## Imports:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "9aa9e67f",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "\n",
    "import h5py\n",
    "import numpy as np\n",
    "from matplotlib import pyplot as plt\n",
    "\n",
    "from material_parameters import my_sig_y\n",
    "from thermontfa import ThermoMechNTFA\n",
    "\n",
    "data_path = \"../\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7f75aa63",
   "metadata": {},
   "source": [
    "## Instantiate ThermoMechNTFA material routine:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "d2c4319b",
   "metadata": {},
   "outputs": [
    {
     "ename": "FileNotFoundError",
     "evalue": "[Errno 2] Unable to synchronously open file (unable to open file: name = 'ms9p_fix_ntfa16_B1-6_10s_N24.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0)",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mFileNotFoundError\u001b[0m                         Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[2], line 1\u001b[0m\n\u001b[0;32m----> 1\u001b[0m ntfa_material \u001b[38;5;241m=\u001b[39m \u001b[43mThermoMechNTFA\u001b[49m\u001b[43m(\u001b[49m\n\u001b[1;32m      2\u001b[0m \u001b[43m    \u001b[49m\u001b[43mfile_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43mms9p_fix_ntfa16_B1-6_10s_N24.h5\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[1;32m      3\u001b[0m \u001b[43m    \u001b[49m\u001b[43mgroup_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43m/\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[1;32m      4\u001b[0m \u001b[43m    \u001b[49m\u001b[43msig_y\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mmy_sig_y\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m      5\u001b[0m \u001b[43m    \u001b[49m\u001b[43mN_max\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;241;43m24\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[1;32m      6\u001b[0m \u001b[43m)\u001b[49m\n",
      "File \u001b[0;32m~/Documents/ThermoNTFA/thermontfa/thermoNTFA.py:88\u001b[0m, in \u001b[0;36mThermoMechNTFA.__init__\u001b[0;34m(self, file_name, group_name, sig_y, N_max, tol, verbose)\u001b[0m\n\u001b[1;32m     85\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mN_max \u001b[38;5;241m=\u001b[39m N_max\n\u001b[1;32m     86\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mverbose \u001b[38;5;241m=\u001b[39m verbose\n\u001b[0;32m---> 88\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mA_bar \u001b[38;5;241m=\u001b[39m \u001b[43mTabularInterpolation\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mfrom_h5\u001b[49m\u001b[43m(\u001b[49m\n\u001b[1;32m     89\u001b[0m \u001b[43m    \u001b[49m\u001b[43mfile_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mfile_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     90\u001b[0m \u001b[43m    \u001b[49m\u001b[43mdset_temps\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mgroup_name\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43m/temperatures\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[1;32m     91\u001b[0m \u001b[43m    \u001b[49m\u001b[43mdset_data\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mgroup_name\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43m/A_bar\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[1;32m     92\u001b[0m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m     94\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mC_bar \u001b[38;5;241m=\u001b[39m TabularInterpolation\u001b[38;5;241m.\u001b[39mfrom_h5(\n\u001b[1;32m     95\u001b[0m     file_name\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mfile_name,\n\u001b[1;32m     96\u001b[0m     dset_temps\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mgroup_name \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m/temperatures\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[1;32m     97\u001b[0m     dset_data\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mgroup_name \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m/C_bar\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[1;32m     98\u001b[0m )\n\u001b[1;32m    100\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mD_xi \u001b[38;5;241m=\u001b[39m TabularInterpolation\u001b[38;5;241m.\u001b[39mfrom_h5(\n\u001b[1;32m    101\u001b[0m     file_name\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mfile_name,\n\u001b[1;32m    102\u001b[0m     dset_temps\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mgroup_name \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m/temperatures\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[1;32m    103\u001b[0m     dset_data\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mgroup_name \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m/D_xi\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[1;32m    104\u001b[0m )\n",
      "File \u001b[0;32m~/Documents/ThermoNTFA/thermontfa/tabular_interpolation.py:119\u001b[0m, in \u001b[0;36mTabularInterpolation.from_h5\u001b[0;34m(cls, file_name, dset_temps, dset_data, transpose_dims, const_extrapolate)\u001b[0m\n\u001b[1;32m     85\u001b[0m \u001b[38;5;129m@classmethod\u001b[39m\n\u001b[1;32m     86\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mfrom_h5\u001b[39m(\n\u001b[1;32m     87\u001b[0m     \u001b[38;5;28mcls\u001b[39m,\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m     92\u001b[0m     const_extrapolate: \u001b[38;5;28mbool\u001b[39m \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[1;32m     93\u001b[0m ) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m Self:\n\u001b[1;32m     94\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[1;32m     95\u001b[0m \u001b[38;5;124;03m    Initialize the tabular interpolator based on tabular data stored in a HDF5 file (*.h5).\u001b[39;00m\n\u001b[1;32m     96\u001b[0m \n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m    117\u001b[0m \u001b[38;5;124;03m    :rtype: TabularInterpolation\u001b[39;00m\n\u001b[1;32m    118\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[0;32m--> 119\u001b[0m     \u001b[38;5;28;01mwith\u001b[39;00m \u001b[43mh5py\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mFile\u001b[49m\u001b[43m(\u001b[49m\u001b[43mfile_name\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;124;43mr\u001b[39;49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m)\u001b[49m \u001b[38;5;28;01mas\u001b[39;00m file:\n\u001b[1;32m    120\u001b[0m         temps \u001b[38;5;241m=\u001b[39m np\u001b[38;5;241m.\u001b[39marray(file[dset_temps])\n\u001b[1;32m    122\u001b[0m         \u001b[38;5;28;01mif\u001b[39;00m transpose_dims \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n",
      "File \u001b[0;32m~/Documents/ThermoNTFA/venv/lib/python3.11/site-packages/h5py/_hl/files.py:562\u001b[0m, in \u001b[0;36mFile.__init__\u001b[0;34m(self, name, mode, driver, libver, userblock_size, swmr, rdcc_nslots, rdcc_nbytes, rdcc_w0, track_order, fs_strategy, fs_persist, fs_threshold, fs_page_size, page_buf_size, min_meta_keep, min_raw_keep, locking, alignment_threshold, alignment_interval, meta_block_size, **kwds)\u001b[0m\n\u001b[1;32m    553\u001b[0m     fapl \u001b[38;5;241m=\u001b[39m make_fapl(driver, libver, rdcc_nslots, rdcc_nbytes, rdcc_w0,\n\u001b[1;32m    554\u001b[0m                      locking, page_buf_size, min_meta_keep, min_raw_keep,\n\u001b[1;32m    555\u001b[0m                      alignment_threshold\u001b[38;5;241m=\u001b[39malignment_threshold,\n\u001b[1;32m    556\u001b[0m                      alignment_interval\u001b[38;5;241m=\u001b[39malignment_interval,\n\u001b[1;32m    557\u001b[0m                      meta_block_size\u001b[38;5;241m=\u001b[39mmeta_block_size,\n\u001b[1;32m    558\u001b[0m                      \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39mkwds)\n\u001b[1;32m    559\u001b[0m     fcpl \u001b[38;5;241m=\u001b[39m make_fcpl(track_order\u001b[38;5;241m=\u001b[39mtrack_order, fs_strategy\u001b[38;5;241m=\u001b[39mfs_strategy,\n\u001b[1;32m    560\u001b[0m                      fs_persist\u001b[38;5;241m=\u001b[39mfs_persist, fs_threshold\u001b[38;5;241m=\u001b[39mfs_threshold,\n\u001b[1;32m    561\u001b[0m                      fs_page_size\u001b[38;5;241m=\u001b[39mfs_page_size)\n\u001b[0;32m--> 562\u001b[0m     fid \u001b[38;5;241m=\u001b[39m \u001b[43mmake_fid\u001b[49m\u001b[43m(\u001b[49m\u001b[43mname\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43muserblock_size\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfapl\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfcpl\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mswmr\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mswmr\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    564\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(libver, \u001b[38;5;28mtuple\u001b[39m):\n\u001b[1;32m    565\u001b[0m     \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_libver \u001b[38;5;241m=\u001b[39m libver\n",
      "File \u001b[0;32m~/Documents/ThermoNTFA/venv/lib/python3.11/site-packages/h5py/_hl/files.py:235\u001b[0m, in \u001b[0;36mmake_fid\u001b[0;34m(name, mode, userblock_size, fapl, fcpl, swmr)\u001b[0m\n\u001b[1;32m    233\u001b[0m     \u001b[38;5;28;01mif\u001b[39;00m swmr \u001b[38;5;129;01mand\u001b[39;00m swmr_support:\n\u001b[1;32m    234\u001b[0m         flags \u001b[38;5;241m|\u001b[39m\u001b[38;5;241m=\u001b[39m h5f\u001b[38;5;241m.\u001b[39mACC_SWMR_READ\n\u001b[0;32m--> 235\u001b[0m     fid \u001b[38;5;241m=\u001b[39m \u001b[43mh5f\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mopen\u001b[49m\u001b[43m(\u001b[49m\u001b[43mname\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mflags\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfapl\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mfapl\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    236\u001b[0m \u001b[38;5;28;01melif\u001b[39;00m mode \u001b[38;5;241m==\u001b[39m \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mr+\u001b[39m\u001b[38;5;124m'\u001b[39m:\n\u001b[1;32m    237\u001b[0m     fid \u001b[38;5;241m=\u001b[39m h5f\u001b[38;5;241m.\u001b[39mopen(name, h5f\u001b[38;5;241m.\u001b[39mACC_RDWR, fapl\u001b[38;5;241m=\u001b[39mfapl)\n",
      "File \u001b[0;32mh5py/_objects.pyx:54\u001b[0m, in \u001b[0;36mh5py._objects.with_phil.wrapper\u001b[0;34m()\u001b[0m\n",
      "File \u001b[0;32mh5py/_objects.pyx:55\u001b[0m, in \u001b[0;36mh5py._objects.with_phil.wrapper\u001b[0;34m()\u001b[0m\n",
      "File \u001b[0;32mh5py/h5f.pyx:102\u001b[0m, in \u001b[0;36mh5py.h5f.open\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;31mFileNotFoundError\u001b[0m: [Errno 2] Unable to synchronously open file (unable to open file: name = 'ms9p_fix_ntfa16_B1-6_10s_N24.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0)"
     ]
    }
   ],
   "source": [
    "file_name = os.path.join(data_path, \"results\", \"ms9p_fix_ntfa16_B1-6_10s_N24.h5\")\n",
    "ntfa_material = ThermoMechNTFA(\n",
    "    file_name=file_name,\n",
    "    group_name=\"/\",\n",
    "    sig_y=my_sig_y,\n",
    "    N_max=24,\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4a4f784c",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# basis = [np.sqrt(2/3) * np.array([1., -.5, -.5, 0, 0, 0]),\n",
    "#          np.sqrt(0.5)*np.array([0., 1., -1., 0, 0, 0]),\n",
    "#          np.array([0, 0, 0, 1, 0, 0]),\n",
    "#          np.array([0, 0, 0, 0, 1, 0]),\n",
    "#          np.array([0, 0, 0, 0, 0, 1]),\n",
    "#          np.array([1, 1, 1, 0, 0, 0])]\n",
    "\n",
    "# i_load = 1\n",
    "# i_theta = 0\n",
    "\n",
    "# with h5py.File(\"all_results_ms9p_16x16x16_10s_N24.h5\", \"r\") as F:\n",
    "#     E = np.array(F[\"/eps\"][i_theta][i_load])\n",
    "#     fans_S = np.array(F['fans/sig'][i_theta][i_load]) / 1000.\n",
    "#     fans_S0 = np.array(F['fans/sig0'][i_theta][i_load]) / 1000.\n",
    "#     fans_S1 = np.array(F['fans/sig1'][i_theta][i_load]) / 1000.\n",
    "#     test_S = np.array(F['ntfa/sig'][i_theta][i_load]) / 1000.\n",
    "#     theta = F['/temperature'][i_theta]\n",
    "\n",
    "# # amp = np.linspace(0, 0.02, 11)\n",
    "# # E = amp[:, None] * \\\n",
    "# #     basis[i_load]\n",
    "# # print(E)\n",
    "# T = np.ones(E.shape[0])*theta\n",
    "# q = 0.\n",
    "# xi = np.zeros(ntfa_material.n_modes)\n",
    "# S = np.zeros(6)\n",
    "# Spred = np.zeros(6)\n",
    "# C = np.zeros((6, 6))\n",
    "# deps = np.zeros(6)\n",
    "# ntfa_S = np.zeros_like(E)\n",
    "# for i in range(E.shape[0]):\n",
    "#     eps = E[i]\n",
    "#     if (i > 0):\n",
    "#         deps = E[i]-E[i-1]\n",
    "#     else:\n",
    "#         deps = np.zeros(6)\n",
    "#     theta = T[i]\n",
    "#     Spred = (S + C@deps)\n",
    "#     xi_n = xi\n",
    "#     S, q, xi, C = ntfa_material.solve(eps, deps, theta, q, xi)\n",
    "#     # recast into MPa (instead of kPa)\n",
    "#     ntfa_S[i, :] = S/1000.\n",
    "#     pred_err = np.linalg.norm(Spred-S)/np.linalg.norm(S)\n",
    "#     print(f'step {i+1:3d} ... S: {S/1000}  (lin. error: {pred_err*100:5.1f}%)')\n",
    "\n",
    "\n",
    "# fig, ax = plt.subplots(1, 1, figsize=(12, 8))\n",
    "# amp = np.linalg.norm(E, axis=1)\n",
    "# ax.plot(amp, np.linalg.norm(fans_S - ntfa_S, axis=1) /\n",
    "#         np.linalg.norm(fans_S, axis=1))\n",
    "# ax.plot(amp, np.linalg.norm(test_S - ntfa_S, axis=1) /\n",
    "#         np.linalg.norm(test_S, axis=1))\n",
    "\n",
    "\n",
    "# with np.set_printoptions( threshold=20, edgeitems=10, linewidth=140,\n",
    "#     formatter = dict( float = lambda x: \"%.3g\" % x )):"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "53e3259a",
   "metadata": {},
   "outputs": [],
   "source": [
    "theta_list = np.linspace(300.0, 1300.0, 5)\n",
    "eps_list = []\n",
    "sig_list = []\n",
    "sig0_list = []\n",
    "sig1_list = []\n",
    "q_list = []\n",
    "xi_list = []\n",
    "with h5py.File(os.path.join(\"data\", \"ms9p_uniaxial_stress_data_mod.h5\"), \"w\") as F:\n",
    "    for iload in range(6):\n",
    "        G = F.create_group(f\"loading{iload:1d}\")\n",
    "        # part 1: theta ramp up in 5 steps\n",
    "        # part 2: add on top a uniaxial loading\n",
    "        for theta in theta_list:\n",
    "            eps_idx = np.array(\n",
    "                [\n",
    "                    iload,\n",
    "                ]\n",
    "            )\n",
    "            sig_idx = np.setdiff1d(np.arange(6), eps_idx)\n",
    "            eps = np.zeros(6)\n",
    "            eps[eps_idx] = 1.0\n",
    "            eps = np.linspace(0, 0.02, 11)[:, None] * eps\n",
    "            ntfa_material.interpolate(theta)\n",
    "            eps_th_el = -np.linalg.solve(ntfa_material.C, ntfa_material.s_th)\n",
    "\n",
    "            (\n",
    "                eps_initial,\n",
    "                sig_initial,\n",
    "                C_initial,\n",
    "                q_initial,\n",
    "                xi_initial,\n",
    "            ) = ntfa_material.UMAT_mixed(\n",
    "                eps_idx=None,\n",
    "                eps_n=np.zeros(6),\n",
    "                deps=np.zeros(6),\n",
    "                sig_bc=np.zeros(6),\n",
    "                theta=theta,\n",
    "                q_n=0.0,\n",
    "                xi_n=np.zeros(ntfa_material.n_modes),\n",
    "            )\n",
    "            print(\"q_ini: \", q_initial, eps_initial - eps_th_el)\n",
    "\n",
    "            # eps = eps + eps_th_el[None, :]\n",
    "            eps = eps + eps_initial\n",
    "            # ntfa_material.A@eps[0] + ntfa_material.t_xi,\n",
    "            # print(\"tau_initial: \",  np.linalg.norm( ntfa_material.A@eps[0] + ntfa_material.t_xi),\n",
    "            #       \";  sig_f: \", ntfa_material.sig_y(theta,0.,False) * np.sqrt(2./3.) * ntfa_material.v_frac[0])\n",
    "            # print(\"before: \", eps[0])\n",
    "            xi = np.zeros(ntfa_material.n_modes)\n",
    "            q = 0.0\n",
    "            C = np.zeros((6, 6))\n",
    "            np.set_printoptions(formatter=dict(float=lambda x: \"%10.3g\" % x))\n",
    "            sig = np.zeros_like(eps)\n",
    "            sig0 = np.zeros_like(eps)\n",
    "            sig1 = np.zeros_like(eps)\n",
    "            xi = np.zeros((eps.shape[0], ntfa_material.n_modes))\n",
    "            q = np.zeros(eps.shape[0])\n",
    "            q_n = 0\n",
    "            xi_n = np.zeros(ntfa_material.n_modes)\n",
    "            for i in range(eps.shape[0]):\n",
    "                if i == 0:\n",
    "                    deps = eps[0].copy()\n",
    "                    eps_n = np.zeros(6)\n",
    "                else:\n",
    "                    deps = eps[i] - eps[i - 1]\n",
    "                    eps_n = eps[i - 1]\n",
    "                eps[i], sig[i], C, q[i], xi[i] = ntfa_material.UMAT_mixed(\n",
    "                    eps_idx, eps_n, deps, np.zeros(6), theta, q_n, xi_n\n",
    "                )\n",
    "                xi_n = xi[i].copy()\n",
    "                q_n = q[i]\n",
    "                sig0[i] = ntfa_material.stress(eps[i], theta, xi[i], i_phase=0)\n",
    "                sig1[i] = ntfa_material.stress(eps[i], theta, xi[i], i_phase=1)\n",
    "                # if( i==0 ):\n",
    "                #     eps_th_el = np.zeros(6)\n",
    "                #     eps_th_el = - np.linalg.solve(ntfa_material.C, ntfa_material.s_th )\n",
    "                #     # eps_th_el[sig_idx] = - np.linalg.solve(ntfa_material.C[sig_idx,:][:,sig_idx],\n",
    "                #                                              ntfa_material.s_th[sig_idx] )\n",
    "                #     print( f\"theta: {theta:6.1f} -- \", (eps[i] - eps_th_el), q[i] )\n",
    "                # print(f'{i:3d} - {sig[i]} - {q[i]:6.4f}')\n",
    "            # print(\"after:  \", eps[0], q[0])\n",
    "            # print(eps)\n",
    "            eps_list.append(eps)\n",
    "            sig_list.append(sig)\n",
    "            sig0_list.append(sig0)\n",
    "            sig1_list.append(sig1)\n",
    "            xi_list.append(xi)\n",
    "            q_list.append(q)\n",
    "            # print(f\"ntfa_T{theta:06.1f}\")\n",
    "            GG = G.create_group(f\"ntfa_T{theta:06.1f}\")\n",
    "            GG.create_dataset(\"eps\", data=eps)\n",
    "            GG.create_dataset(\"sig\", data=sig)\n",
    "            GG.create_dataset(\"sig0\", data=sig0)\n",
    "            GG.create_dataset(\"sig1\", data=sig1)\n",
    "            GG.create_dataset(\"q\", data=q)\n",
    "            GG.create_dataset(\"xi\", data=xi)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6c7a6c84",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "# run uniaxial strain controlled tests at different temperatures\n",
    "# the initial state is gained by ramping up the temperature from 293 K\n",
    "# subsequently, a strain controlled loading is superimposed in the iload-th\n",
    "# component (2% loading).\n",
    "\n",
    "\n",
    "theta_list = np.linspace(300.0, 1300.0, 5)\n",
    "eps_list = []\n",
    "sig_list = []\n",
    "sig0_list = []\n",
    "sig1_list = []\n",
    "q_list = []\n",
    "xi_list = []\n",
    "n_ramp = 10\n",
    "with h5py.File(os.path.join(\"data\", \"ms9p_uniaxial_stress_data_mod.h5\"), \"w\") as F:\n",
    "    for iload in range(6):\n",
    "        G = F.create_group(f\"loading{iload:1d}\")\n",
    "        # part 1: theta ramp up in 5 steps\n",
    "        # part 2: add on top a uniaxial loading\n",
    "        for theta in theta_list:\n",
    "            eps_idx = np.array(\n",
    "                [\n",
    "                    iload,\n",
    "                ]\n",
    "            )\n",
    "            sig_idx = np.setdiff1d(np.arange(6), eps_idx)\n",
    "            eps = np.zeros(6)\n",
    "            eps[eps_idx] = 1.0\n",
    "            # the actual loading we are seeking:\n",
    "            eps_bc = np.zeros((10 + n_ramp, 6))\n",
    "            eps_bc[(n_ramp - 1) :, eps_idx] = np.linspace(0, 0.02, 11)[:, None]\n",
    "\n",
    "            # part 1: ramp up theta from 293 K to theta\n",
    "            T = np.zeros(n_ramp + 10)\n",
    "            theta_ramp = np.linspace(293.0, theta, n_ramp)\n",
    "            T[:n_ramp] = theta_ramp\n",
    "            T[n_ramp:] = theta\n",
    "\n",
    "            # ntfa_material.A@eps[0] + ntfa_material.t_xi,\n",
    "            # print(\"tau_initial: \",  np.linalg.norm( ntfa_material.A@eps[0] + ntfa_material.t_xi),\n",
    "            #       \";  sig_f: \", ntfa_material.sig_y(theta,0.,False) * np.sqrt(2./3.) * ntfa_material.v_frac[0])\n",
    "            # print(\"before: \", eps[0])\n",
    "            xi = np.zeros(ntfa_material.n_modes)\n",
    "            q = 0.0\n",
    "            C = np.zeros((6, 6))\n",
    "            np.set_printoptions(formatter=dict(float=lambda x: \"%10.3g\" % x))\n",
    "            eps = np.zeros_like(eps_bc)\n",
    "            sig = np.zeros_like(eps)\n",
    "            sig0 = np.zeros_like(eps)\n",
    "            sig1 = np.zeros_like(eps)\n",
    "            xi = np.zeros((eps.shape[0], ntfa_material.n_modes))\n",
    "            q = np.zeros(eps.shape[0])\n",
    "            q_n = 0.0\n",
    "            xi_n = np.zeros(ntfa_material.n_modes)\n",
    "            for i in range(eps.shape[0]):\n",
    "                t = T[i]\n",
    "                if i == 0:\n",
    "                    deps = eps_bc[0].copy()\n",
    "                    eps_n = np.zeros(6)\n",
    "                else:\n",
    "                    deps = eps_bc[i] - eps[i - 1]\n",
    "                    eps_n = eps[i - 1]\n",
    "                if i < n_ramp:\n",
    "                    # this induces stress free loading with free strains\n",
    "                    eps_idx = None\n",
    "                else:\n",
    "                    eps_idx = np.array(\n",
    "                        [\n",
    "                            iload,\n",
    "                        ]\n",
    "                    )\n",
    "                eps[i], sig[i], C, q[i], xi[i] = ntfa_material.UMAT_mixed(\n",
    "                    eps_idx=eps_idx,\n",
    "                    eps_n=eps_n,\n",
    "                    deps=deps,\n",
    "                    sig_bc=np.zeros(6),\n",
    "                    theta=t,\n",
    "                    q_n=q_n,\n",
    "                    xi_n=xi_n,\n",
    "                )\n",
    "                xi_n = xi[i].copy()\n",
    "                q_n = q[i]\n",
    "                sig0[i] = ntfa_material.stress(eps[i], t, xi[i], i_phase=0)\n",
    "                sig1[i] = ntfa_material.stress(eps[i], t, xi[i], i_phase=1)\n",
    "                # print(t, eps[i], q[i])\n",
    "                if i == n_ramp - 1:\n",
    "                    # update the BC!\n",
    "                    eps_bc[n_ramp:, :] += eps[n_ramp - 1][None, :]\n",
    "                    # print(t, eps[i], q[i])\n",
    "                # if( i==0 ):\n",
    "                #     eps_th_el = np.zeros(6)\n",
    "                #     eps_th_el = - np.linalg.solve(ntfa_material.C, ntfa_material.s_th )\n",
    "                #     # eps_th_el[sig_idx] = - np.linalg.solve(ntfa_material.C[sig_idx,:][:,sig_idx],\n",
    "                #                                              ntfa_material.s_th[sig_idx] )\n",
    "                #     print( f\"theta: {theta:6.1f} -- \", (eps[i] - eps_th_el), q[i] )\n",
    "                # print(f'{i:3d} - {sig[i]} - {q[i]:6.4f}')\n",
    "            # print(\"after:  \", eps[0], q[0])\n",
    "            # print(eps)\n",
    "            eps_list.append(eps)\n",
    "            sig_list.append(sig)\n",
    "            sig0_list.append(sig0)\n",
    "            sig1_list.append(sig1)\n",
    "            xi_list.append(xi)\n",
    "            q_list.append(q)\n",
    "            # print(f\"ntfa_T{theta:06.1f}\")\n",
    "            GG = G.create_group(f\"ntfa_T{theta:06.1f}\")\n",
    "            GG.create_dataset(\"T\", data=T)\n",
    "            GG.create_dataset(\"eps\", data=eps)\n",
    "            GG.create_dataset(\"sig\", data=sig)\n",
    "            GG.create_dataset(\"sig0\", data=sig0)\n",
    "            GG.create_dataset(\"sig1\", data=sig1)\n",
    "            GG.create_dataset(\"q\", data=q)\n",
    "            GG.create_dataset(\"xi\", data=xi)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4bf15572",
   "metadata": {
    "title": "Figuring when plasticity kicks in using the mixed UMAT"
   },
   "outputs": [],
   "source": [
    "# 1. set the stress to 0\n",
    "# 2. ramp the temperature from 293K\n",
    "# 3. check for q >= q_crit_0, q_crit_1, ...\n",
    "#    e.g. q_crit_0 = 0.002 (i.e. 0.2%)\n",
    "# draw the results of theta\n",
    "\n",
    "n_ramp = 1300 - 293 + 1\n",
    "with h5py.File(os.path.join(\"data\", \"ms9p_thermal_rampup.h5\"), \"w\") as F:\n",
    "    eps_idx = None\n",
    "    sig_idx = np.arange(6)\n",
    "    eps = np.zeros(6)\n",
    "    # the actual loading we are seeking:\n",
    "    eps_bc = np.zeros((n_ramp, 6))\n",
    "\n",
    "    # part 1: ramp up theta from 293 K to theta\n",
    "    T = np.linspace(293.0, 1300.0, n_ramp)\n",
    "    q = 0.0\n",
    "    C = np.zeros((6, 6))\n",
    "    np.set_printoptions(formatter=dict(float=lambda x: \"%10.3g\" % x))\n",
    "    eps = np.zeros_like(eps_bc)\n",
    "    sig = np.zeros_like(eps)\n",
    "    sig0 = np.zeros_like(eps)\n",
    "    sig1 = np.zeros_like(eps)\n",
    "    xi = np.zeros((eps.shape[0], ntfa_material.n_modes))\n",
    "    q = np.zeros(eps.shape[0])\n",
    "    q_n = 0.0\n",
    "    xi_n = np.zeros(ntfa_material.n_modes)\n",
    "    for i in range(eps.shape[0]):\n",
    "        t = T[i]\n",
    "        if i == 0:\n",
    "            deps = eps_bc[0].copy()\n",
    "            eps_n = np.zeros(6)\n",
    "        else:\n",
    "            deps = eps_bc[i] - eps[i - 1]\n",
    "            eps_n = eps[i - 1]\n",
    "        eps[i], sig[i], C, q[i], xi[i] = ntfa_material.UMAT_mixed(\n",
    "            eps_idx, eps_n, deps, np.zeros(6), t, q_n, xi_n\n",
    "        )\n",
    "        xi_n = xi[i].copy()\n",
    "        q_n = q[i]\n",
    "        sig0[i] = ntfa_material.stress(eps[i], t, xi[i], i_phase=0)\n",
    "        sig1[i] = ntfa_material.stress(eps[i], t, xi[i], i_phase=1)\n",
    "        # print(t, eps[i], q[i])\n",
    "    # print(f\"ntfa_T{theta:06.1f}\")\n",
    "    F.create_dataset(\"T\", data=T)\n",
    "    F.create_dataset(\"eps\", data=eps)\n",
    "    F.create_dataset(\"sig\", data=sig)\n",
    "    F.create_dataset(\"sig0\", data=sig0)\n",
    "    F.create_dataset(\"sig1\", data=sig1)\n",
    "    F.create_dataset(\"q\", data=q)\n",
    "    F.create_dataset(\"xi\", data=xi)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "58f36d95",
   "metadata": {},
   "outputs": [],
   "source": [
    "q_crit = [1e-5, 0.002, 0.005, 0.01]\n",
    "with h5py.File(os.path.join(\"data\", \"ms9p_thermal_rampup.h5\"), \"r\") as F:\n",
    "    q = np.array(F[\"q\"])\n",
    "    T = np.array(F[\"T\"])\n",
    "    eps = np.array(F[\"eps\"])\n",
    "    sig0 = np.array(F[\"sig0\"])\n",
    "    sig1 = np.array(F[\"sig1\"])\n",
    "    fig, ax = plt.subplots(1, 1, figsize=(12, 7))\n",
    "    ax.plot(T, 100 * q, color=\"red\", lw=2, label=r\"NTFA $\\overline{q}$\")\n",
    "    for qc in q_crit:\n",
    "        ax.plot([T[0], T[-1]], [100 * qc, 100 * qc], color=\"black\", lw=1)\n",
    "        i = np.searchsorted(q, qc)\n",
    "        ax.annotate(\n",
    "            text=rf\"$q_c={qc * 100}\\%, T={T[i]}K$\",\n",
    "            xy=[T[i], 100 * q[i]],\n",
    "            xytext=[T[i] - 150, 100 * q[i] + 0.2],\n",
    "            color=\"blue\",\n",
    "            arrowprops=dict(width=2),\n",
    "        )\n",
    "\n",
    "ax.grid()\n",
    "ax.set_xlim(T[0], T[-1])\n",
    "ax.set_xlabel(r\"temperature $T$ [K]\")\n",
    "ax.set_ylabel(r\"hardening variable $\\overline{q}$ [%]\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "98af05a2",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "sig_fe_list = []\n",
    "sig0_fe_list = []\n",
    "sig1_fe_list = []\n",
    "\n",
    "# with h5py.File(\"ms9p_uniaxial_stress_data_loading0-5.h5\", \"r\") as F:\n",
    "with h5py.File(\n",
    "    os.path.join(\"data\", \"ms9p_uniaxial_stress_data_mod_loading0.h5\"), \"r\"\n",
    ") as F:\n",
    "    for iload in range(1):\n",
    "        G = F[f\"loading{iload:1d}\"]\n",
    "        for theta in theta_list:\n",
    "            GG = G[f\"ntfa_T{theta:06.1f}\"]\n",
    "            sig_fe = np.array(GG[\"fe_sig\"])\n",
    "            sig0_fe = np.array(GG[\"fe_sig0\"])\n",
    "            sig1_fe = np.array(GG[\"fe_sig1\"])\n",
    "            sig_fe_list.append(sig_fe)\n",
    "            sig0_fe_list.append(sig0_fe)\n",
    "            sig1_fe_list.append(sig1_fe)\n",
    "\n",
    "\n",
    "def rel_error(A, A_ref, r_min=None):\n",
    "    if r_min is None:\n",
    "        return np.linalg.norm(A - A_ref, axis=1) / np.linalg.norm(A_ref, axis=1)\n",
    "    else:\n",
    "        return np.linalg.norm(A - A_ref, axis=1) / (\n",
    "            np.maximum(r_min, np.linalg.norm(A_ref, axis=1))\n",
    "        )\n",
    "\n",
    "\n",
    "n = len(sig_fe_list)\n",
    "\n",
    "for k in [0, 1, 2, 3, 4]:\n",
    "    fig, ax = plt.subplots(1, 2, figsize=(8, 4.5))\n",
    "    # fig.suptitle(rf\"$T={theta_list[np.mod(k,5)]}$ - rel. error (overall/matrix/inclusion)\")\n",
    "    temp = theta_list[np.mod(k, 5)]\n",
    "    fig.suptitle(rf\"$T={temp}$ - rel. error (matrix/inclusion)\")\n",
    "    c1 = ntfa_material.v_frac[0]\n",
    "    c2 = ntfa_material.v_frac[1]\n",
    "    sig_list[k] = c1 * sig0_list[k] + c2 * sig1_list[k]\n",
    "    # delta =   c1 * sig0_list[k] + c2 * sig1_list[k] - sig_list[k]\n",
    "    # print(rel_error(  c1 * sig0_fe_list[k] + c2 * sig1_fe_list[k], sig_fe_list[k] ))\n",
    "    err_sig = rel_error(sig_list[k], sig_fe_list[k], r_min=1e4)\n",
    "    err_sig0 = rel_error(sig0_list[k], sig0_fe_list[k], r_min=1e4)\n",
    "    err_sig1 = rel_error(sig1_list[k], sig1_fe_list[k], r_min=1e4)\n",
    "    t = np.linspace(0, 1, sig_list[k].shape[0])\n",
    "    ax[0].plot(t[:], err_sig0[:] * 100)\n",
    "    ax[1].plot(t[:], err_sig1[:] * 100)\n",
    "    for A in ax:\n",
    "        A.grid()\n",
    "        A.set_xlabel(\"rel. time [-]\")\n",
    "        A.set_ylabel(\"rel. error [%]\")\n",
    "        A.set_ylim([0, 10])\n",
    "    ax[0].text(0.55, 1, \"plastic matrix\", backgroundcolor=\"#004191\", color=\"white\")\n",
    "    ax[1].text(0.55, 1, \"elastic particles\", backgroundcolor=\"#004191\", color=\"white\")\n",
    "    fig.tight_layout()\n",
    "    plt.savefig(os.path.join(\"results\", f\"rel_error_uniaxial_T{temp:.0f}.jpg\"))\n",
    "    # ax[0].plot(t[:], err_sig[:]*100)\n",
    "    # ax[1].plot(t[:], err_sig0[:]*100)\n",
    "    # ax[2].plot(t[:], err_sig1[:]*100)\n",
    "\n",
    "    # print( sig_list[k] - ntfa_material.v_frac[0] * sig0_list[k] - ntfa_material.v_frac[1] * sig1_list[k] )\n",
    "    # print(f'rel. error in sig   {100*err_sig}%')\n",
    "    # print(f'rel. error in sig0  {100*err_sig0}%')\n",
    "    # print(f'rel. error in sig1  {100*err_sig1}%')"
   ]
  }
 ],
 "metadata": {
  "jupytext": {
   "cell_metadata_filter": "title,-all",
   "formats": "ipynb,py:percent",
   "main_language": "python",
   "notebook_metadata_filter": "-all"
  },
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
